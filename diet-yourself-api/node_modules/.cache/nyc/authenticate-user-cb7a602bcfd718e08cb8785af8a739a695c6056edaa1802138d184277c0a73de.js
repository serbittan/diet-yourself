function cov_1qw1n3k5pw(){var path="/Users/sergibittangonzalez/bootcamp/collab/skylab-bootcamp-202001/staff/sergi-bittan/diet-yourself/diet-yourself-api/logic/authenticate-user.js";var hash="8855c49b5fd52773ae4083b736a6535ed59cc21d";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Users/sergibittangonzalez/bootcamp/collab/skylab-bootcamp-202001/staff/sergi-bittan/diet-yourself/diet-yourself-api/logic/authenticate-user.js",statementMap:{"0":{start:{line:1,column:21},end:{line:1,column:51}},"1":{start:{line:2,column:29},end:{line:2,column:58}},"2":{start:{line:3,column:28},end:{line:3,column:59}},"3":{start:{line:4,column:15},end:{line:4,column:34}},"4":{start:{line:18,column:0},end:{line:38,column:1}},"5":{start:{line:19,column:4},end:{line:19,column:35}},"6":{start:{line:20,column:4},end:{line:20,column:25}},"7":{start:{line:21,column:4},end:{line:21,column:41}},"8":{start:{line:24,column:4},end:{line:37,column:10}},"9":{start:{line:26,column:12},end:{line:26,column:69}},"10":{start:{line:26,column:23},end:{line:26,column:69}},"11":{start:{line:28,column:12},end:{line:36,column:37}},"12":{start:{line:30,column:20},end:{line:30,column:86}},"13":{start:{line:30,column:40},end:{line:30,column:86}},"14":{start:{line:32,column:20},end:{line:32,column:49}},"15":{start:{line:34,column:20},end:{line:34,column:38}},"16":{start:{line:36,column:34},end:{line:36,column:36}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:18,column:17},end:{line:18,column:18}},loc:{start:{line:18,column:38},end:{line:38,column:1}},line:18},"1":{name:"(anonymous_1)",decl:{start:{line:25,column:14},end:{line:25,column:15}},loc:{start:{line:25,column:22},end:{line:37,column:9}},line:25},"2":{name:"(anonymous_2)",decl:{start:{line:29,column:22},end:{line:29,column:23}},loc:{start:{line:29,column:39},end:{line:35,column:17}},line:29},"3":{name:"(anonymous_3)",decl:{start:{line:36,column:22},end:{line:36,column:23}},loc:{start:{line:36,column:34},end:{line:36,column:36}},line:36}},branchMap:{"0":{loc:{start:{line:26,column:12},end:{line:26,column:69}},type:"if",locations:[{start:{line:26,column:12},end:{line:26,column:69}},{start:{line:26,column:12},end:{line:26,column:69}}],line:26},"1":{loc:{start:{line:30,column:20},end:{line:30,column:86}},type:"if",locations:[{start:{line:30,column:20},end:{line:30,column:86}},{start:{line:30,column:20},end:{line:30,column:86}}],line:30}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0},f:{"0":0,"1":0,"2":0,"3":0},b:{"0":[0,0],"1":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"8855c49b5fd52773ae4083b736a6535ed59cc21d"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_1qw1n3k5pw=function(){return actualCoverage;};return actualCoverage;}cov_1qw1n3k5pw();const{validate}=(cov_1qw1n3k5pw().s[0]++,require('diet-yourself-utils'));const{models:{User}}=(cov_1qw1n3k5pw().s[1]++,require('diet-yourself-data'));const{NotAllowedError}=(cov_1qw1n3k5pw().s[2]++,require('diet-yourself-errors'));const bcrypt=(cov_1qw1n3k5pw().s[3]++,require('bcryptjs'));/**
 * Checks user credentials against the storage
 * 
 * @param {string} email user's unique e-mail
 * @param {string} password user's password
 * 
 * @returns {Promise<string>} user id from storage
 * 
 * @throws {ContentError} if user data does not follow the format and content rules
 * @throws {TypeError} if user data does not have the correct type
 * @throws {NotAllowedError} on wrong credentials
 */cov_1qw1n3k5pw().s[4]++;module.exports=(email,password)=>{cov_1qw1n3k5pw().f[0]++;cov_1qw1n3k5pw().s[5]++;validate.string(email,'email');cov_1qw1n3k5pw().s[6]++;validate.email(email);cov_1qw1n3k5pw().s[7]++;validate.string(password,'password');cov_1qw1n3k5pw().s[8]++;return User.findOne({email}).then(user=>{cov_1qw1n3k5pw().f[1]++;cov_1qw1n3k5pw().s[9]++;if(!user){cov_1qw1n3k5pw().b[0][0]++;cov_1qw1n3k5pw().s[10]++;throw new NotAllowedError(`wrong credentials`);}else{cov_1qw1n3k5pw().b[0][1]++;}cov_1qw1n3k5pw().s[11]++;return bcrypt.compare(password,user.password).then(validPassword=>{cov_1qw1n3k5pw().f[2]++;cov_1qw1n3k5pw().s[12]++;if(!validPassword){cov_1qw1n3k5pw().b[1][0]++;cov_1qw1n3k5pw().s[13]++;throw new NotAllowedError(`wrong credentials`);}else{cov_1qw1n3k5pw().b[1][1]++;}cov_1qw1n3k5pw().s[14]++;user.authenticated=new Date();cov_1qw1n3k5pw().s[15]++;return user.save();}).then(({id})=>{cov_1qw1n3k5pw().f[3]++;cov_1qw1n3k5pw().s[16]++;return id;});});};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF1dGhlbnRpY2F0ZS11c2VyLmpzIl0sIm5hbWVzIjpbInZhbGlkYXRlIiwicmVxdWlyZSIsIm1vZGVscyIsIlVzZXIiLCJOb3RBbGxvd2VkRXJyb3IiLCJiY3J5cHQiLCJtb2R1bGUiLCJleHBvcnRzIiwiZW1haWwiLCJwYXNzd29yZCIsInN0cmluZyIsImZpbmRPbmUiLCJ0aGVuIiwidXNlciIsImNvbXBhcmUiLCJ2YWxpZFBhc3N3b3JkIiwiYXV0aGVudGljYXRlZCIsIkRhdGUiLCJzYXZlIiwiaWQiXSwibWFwcGluZ3MiOiJpNEZBQUEsS0FBTSxDQUFFQSxRQUFGLDJCQUFlQyxPQUFPLENBQUMscUJBQUQsQ0FBdEIsQ0FBTixDQUNBLEtBQU0sQ0FBRUMsTUFBTSxDQUFFLENBQUVDLElBQUYsQ0FBViwyQkFBdUJGLE9BQU8sQ0FBQyxvQkFBRCxDQUE5QixDQUFOLENBQ0EsS0FBTSxDQUFFRyxlQUFGLDJCQUFzQkgsT0FBTyxDQUFDLHNCQUFELENBQTdCLENBQU4sQ0FDQSxLQUFNSSxDQUFBQSxNQUFNLDBCQUFHSixPQUFPLENBQUMsVUFBRCxDQUFWLENBQVosQ0FFQTs7Ozs7Ozs7Ozs7MkJBWUFLLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUFDQyxLQUFELENBQVFDLFFBQVIsR0FBcUIsaURBQ2xDVCxRQUFRLENBQUNVLE1BQVQsQ0FBZ0JGLEtBQWhCLENBQXVCLE9BQXZCLEVBRGtDLHdCQUVsQ1IsUUFBUSxDQUFDUSxLQUFULENBQWVBLEtBQWYsRUFGa0Msd0JBR2xDUixRQUFRLENBQUNVLE1BQVQsQ0FBZ0JELFFBQWhCLENBQTBCLFVBQTFCLEVBSGtDLHdCQU1sQyxNQUFPTixDQUFBQSxJQUFJLENBQUNRLE9BQUwsQ0FBYSxDQUFFSCxLQUFGLENBQWIsRUFDRkksSUFERSxDQUNHQyxJQUFJLEVBQUksaURBQ1YsR0FBSSxDQUFDQSxJQUFMLENBQVcsMERBQU0sSUFBSVQsQ0FBQUEsZUFBSixDQUFxQixtQkFBckIsQ0FBTixDQUE4QyxDQUF6RCxpQ0FEVSx5QkFHVixNQUFPQyxDQUFBQSxNQUFNLENBQUNTLE9BQVAsQ0FBZUwsUUFBZixDQUF5QkksSUFBSSxDQUFDSixRQUE5QixFQUNGRyxJQURFLENBQ0dHLGFBQWEsRUFBSSxrREFDbkIsR0FBSSxDQUFDQSxhQUFMLENBQW9CLDBEQUFNLElBQUlYLENBQUFBLGVBQUosQ0FBcUIsbUJBQXJCLENBQU4sQ0FBOEMsQ0FBbEUsaUNBRG1CLHlCQUduQlMsSUFBSSxDQUFDRyxhQUFMLENBQXFCLEdBQUlDLENBQUFBLElBQUosRUFBckIsQ0FIbUIseUJBS25CLE1BQU9KLENBQUFBLElBQUksQ0FBQ0ssSUFBTCxFQUFQLENBQ0gsQ0FQRSxFQVFGTixJQVJFLENBUUcsQ0FBQyxDQUFFTyxFQUFGLENBQUQsR0FBWUEsd0RBQUFBLENBQUFBLEVBQUUsRUFSakIsQ0FBUCxDQVNILENBYkUsQ0FBUCxDQWNILENBcEJEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyB2YWxpZGF0ZSB9ID0gcmVxdWlyZSgnZGlldC15b3Vyc2VsZi11dGlscycpXG5jb25zdCB7IG1vZGVsczogeyBVc2VyIH0gfSA9IHJlcXVpcmUoJ2RpZXQteW91cnNlbGYtZGF0YScpXG5jb25zdCB7IE5vdEFsbG93ZWRFcnJvciB9ID0gcmVxdWlyZSgnZGlldC15b3Vyc2VsZi1lcnJvcnMnKVxuY29uc3QgYmNyeXB0ID0gcmVxdWlyZSgnYmNyeXB0anMnKVxuXG4vKipcbiAqIENoZWNrcyB1c2VyIGNyZWRlbnRpYWxzIGFnYWluc3QgdGhlIHN0b3JhZ2VcbiAqIFxuICogQHBhcmFtIHtzdHJpbmd9IGVtYWlsIHVzZXIncyB1bmlxdWUgZS1tYWlsXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFzc3dvcmQgdXNlcidzIHBhc3N3b3JkXG4gKiBcbiAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IHVzZXIgaWQgZnJvbSBzdG9yYWdlXG4gKiBcbiAqIEB0aHJvd3Mge0NvbnRlbnRFcnJvcn0gaWYgdXNlciBkYXRhIGRvZXMgbm90IGZvbGxvdyB0aGUgZm9ybWF0IGFuZCBjb250ZW50IHJ1bGVzXG4gKiBAdGhyb3dzIHtUeXBlRXJyb3J9IGlmIHVzZXIgZGF0YSBkb2VzIG5vdCBoYXZlIHRoZSBjb3JyZWN0IHR5cGVcbiAqIEB0aHJvd3Mge05vdEFsbG93ZWRFcnJvcn0gb24gd3JvbmcgY3JlZGVudGlhbHNcbiAqL1xubW9kdWxlLmV4cG9ydHMgPSAoZW1haWwsIHBhc3N3b3JkKSA9PiB7XG4gICAgdmFsaWRhdGUuc3RyaW5nKGVtYWlsLCAnZW1haWwnKVxuICAgIHZhbGlkYXRlLmVtYWlsKGVtYWlsKVxuICAgIHZhbGlkYXRlLnN0cmluZyhwYXNzd29yZCwgJ3Bhc3N3b3JkJylcblxuICAgIFxuICAgIHJldHVybiBVc2VyLmZpbmRPbmUoeyBlbWFpbCB9KVxuICAgICAgICAudGhlbih1c2VyID0+IHtcbiAgICAgICAgICAgIGlmICghdXNlcikgdGhyb3cgbmV3IE5vdEFsbG93ZWRFcnJvcihgd3JvbmcgY3JlZGVudGlhbHNgKVxuXG4gICAgICAgICAgICByZXR1cm4gYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpXG4gICAgICAgICAgICAgICAgLnRoZW4odmFsaWRQYXNzd29yZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRQYXNzd29yZCkgdGhyb3cgbmV3IE5vdEFsbG93ZWRFcnJvcihgd3JvbmcgY3JlZGVudGlhbHNgKVxuXG4gICAgICAgICAgICAgICAgICAgIHVzZXIuYXV0aGVudGljYXRlZCA9IG5ldyBEYXRlXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVzZXIuc2F2ZSgpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoeyBpZCB9KSA9PiBpZClcbiAgICAgICAgfSlcbn1cblxuXG4iXX0=